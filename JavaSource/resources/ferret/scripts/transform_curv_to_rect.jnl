! transform_curv_to_rect.jnl
! 
! ACM 10/2006
!      4/2007 ACM Apply Ferret symbols for any expression that may have been defined
!
set mode ver:always

! incoming symbols define the regridding and where its to be centered
!   DEFINE SYMBOL constraint_0_op = eq
!   DEFINE SYMBOL constraint_0_lhs = Curv_to_Rect_Regridding


! Set up to regrid from curvilinear to rectilinear using
! symbols defined before calling this script.
! The region and dataset have already been initialized.
! The script expects a mapping file which defines the regridding.

!  ($data_var)    - Name of variable on native curvilinear grid
!  ($cf_map_n_file) - pre-generated curvilinear to rectlinear map
!                   using CURV_TO_RECT_MAP external function 
!  ($cf_map_n_var)  - curvilinear to rectlinear map variable 
!
! set curvilinear mapping dataset

IF ($cf_map_($num)_chained"0|1|*>1) THEN
  DEFINE SYMBOL cf_map_url \"($ferret_curvi_coord_map2file)\"
  IF ($constraint_0_rhs"0|5|*>0) THEN DEFINE SYMBOL cf_map_url \"($ferret_curvi_coord_map5file)\"
ELSE
  DEFINE SYMBOL cf_map_url \"($ferret_curvi_coord_map2file)\"
  IF ($constraint_0_rhs"0|5|*>0) THEN DEFINE SYMBOL cf_map_url \"($ferret_curvi_coord_map5file)\"
ENDIF

DEFINE SYMBOL cf_map_var = ($ferret_curvi_coord_mapvar)
SET DATA ($cf_map_url)
DEFINE SYMBOL mapfile_num = `($cf_map_var),return=dsetnum`

! regrid, applying region information last

LET the_var_curv = ($data_var)

! DEFINE SYMBOL the_var_title = "`($data_var)[d=($data_num)],return=title`"
! DEFINE SYMBOL the_var_units = "`($data_var)[d=($data_num)],return=units`"

LET the_var_rect = CURV_TO_RECT(the_var_curv[d=($data_num)],($cf_map_var)[d=($mapfile_num)])
IF ($reg_zt"0|*>1)) THEN \
 LET the_var_rect = CURV_TO_RECT(the_var_curv[d=($data_num),($reg_zt)],($cf_map_var)[d=($mapfile_num)])
load the_var_rect

LET the_var_rect_region = the_var_rect[($region_full)]

DEFINE SYMBOL ferret_plot_var ($expr1)the_var_rect_region($expr2)

DEFINE SYMBOL ferret_plot_title @AC($expr1) ($data_title) ($expr2) (($data_units)) Regridded to ($constraint_0_rhs)@IM09@AC Grid

IF ($expr3"0|*>1") THEN
   DEFINE SYMBOL ferret_plot_var ($expr1)the_var_rect_region($expr3)the_var_rect_region($expr4)
   DEFINE SYMBOL ferret_plot_title ($expr1) ($data_title) ($expr3) ($data_title) ($expr4) (($data_units)) Regridded to ($constraint_0_rhs)@IM09@AC Grid
ENDIF

! End of $RCSfile ---------- transform_curv_to_rect.jnl----------------------------
